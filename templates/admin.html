<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Display Admin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg: #1a1a1a; --card: #2d2d2d; --text: #e0e0e0; --input: #404040; --border: #555;
            --primary: #007bff; --success: #28a745; --danger: #dc3545; --warning: #ffc107;
            --tab-active: #2d2d2d; --tab-inactive: #181818;
        }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); padding-bottom: 80px;}
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid var(--border); }
        .tab-btn { padding: 12px 20px; cursor: pointer; background: var(--tab-inactive); color: #888; border: none; border-radius: 8px 8px 0 0; font-size: 16px; font-weight: bold; flex: 1; transition: 0.2s; }
        .tab-btn:hover { background: #252525; color: white; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card); padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-bottom: 25px; border: 1px solid var(--border); }
        h2 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 15px; color: var(--primary); font-size: 1.4em;}
        h3 { margin-bottom: 10px; color: #bbb; font-size: 1.1em; border-left: 3px solid var(--primary); padding-left: 10px;}
        label { font-weight: 600; display: block; margin-top: 15px; margin-bottom: 5px; font-size: 0.9em; color: #ccc; }
        input[type="text"], input[type="number"], input[type="datetime-local"], select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-size: 15px; background: var(--input); color: white; transition: border 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; }
        input.time-input { width: 90px; text-align: center; letter-spacing: 1px; font-family: monospace; font-weight: bold;}
        input[type="checkbox"] { width: 18px; height: 18px; transform: translateY(4px); margin-right: 10px; cursor: pointer;}
        input[type="color"] { width: 100%; height: 40px; border: none; cursor: pointer; padding: 0; background: none; border-radius: 4px;}
        .playlist-item { display: flex; align-items: center; background: var(--input); border: 1px solid var(--border); padding: 10px; margin-bottom: 8px; border-radius: 6px; cursor: move; transition: transform 0.1s, background 0.2s; }
        .playlist-item:hover { background: #333; border-color: #666; }
        .thumb { width: 80px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 15px; background: #000;}
        .details { flex-grow: 1; }
        .time-inputs { display: flex; gap: 10px; align-items: center; margin-top: 3px; flex-wrap: wrap;}
        .time-inputs span { font-size: 0.85em; color: #aaa; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: bold; text-align: center; transition: 0.2s; display: inline-block;}
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-save { background: var(--success); color: white; width: 100%; margin-top: 10px; font-size: 1.1em;}
        .btn-upload { background: var(--primary); color: white; width: 100%;}
        .btn-create { background: #6f42c1; color: white; width: 100%; margin-top: 10px;} 
        .btn-delete { background: transparent; color: #ff6b6b; padding: 8px; font-size: 1.2em; margin-left: 5px; border: 1px solid var(--border); border-radius: 4px;}
        .btn-delete:hover { background: rgba(255,0,0,0.1); border-color: #ff6b6b; }
        .btn-danger { background: var(--danger); color: white; width: 100%; margin-top: 5px; }
        .btn-dark { background: #444; color: white; width: 100%; margin-top: 5px; }
        .btn-warning { background: var(--warning); color: #222; width: 100%; margin-top: 5px; }
        .logout { float: right; color: #888; text-decoration: none; font-size: 14px; margin-top: 5px;}
        .row { display: flex; gap: 20px; flex-wrap: wrap;}
        .col { flex: 1; min-width: 250px; }
        hr { margin: 25px 0; border: 0; border-top: 1px solid var(--border); }
        .stat-bar-bg { width: 100%; background: #333; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .stat-bar-fill { height: 100%; background: var(--success); }
        .temp-badge { background: #17a2b8; color: white; padding: 3px 8px; border-radius: 4px; font-size: 13px; margin-left: 5px;}
        .live-active { border: 2px solid #ff4444; box-shadow: 0 0 15px rgba(255, 68, 68, 0.2); }
        .live-badge { background: #ff4444; color: white; padding: 5px 10px; border-radius: 4px; font-weight: bold; display: inline-block; margin-bottom: 10px;}
        .sticky-save { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(30, 30, 30, 0.95); border-top: 1px solid var(--primary); padding: 15px; text-align: center; backdrop-filter: blur(5px); z-index: 100; display: none; }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin:0;">üì± Bar Display Manager</h1>
        <a href="{{ url_for('logout') }}" class="logout">Logout ‚ûî</a>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('dashboard')">üè† Dashboard</button>
        <button class="tab-btn" onclick="openTab('media')">üìÇ Medien & Playlist</button>
        <button class="tab-btn" onclick="openTab('design')">üé® Design & Layout</button>
        <button class="tab-btn" onclick="openTab('system')">‚öôÔ∏è System</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div class="card {% if override.active %}live-active{% endif %}">
            <h2>üö® Live Regie</h2>
            {% if override.active %}
                <div class="live-badge">AKTIV: {{ override.content }}</div>
            {% else %}
                <p style="color:#888; margin-top:0;">Unterbreche die Playlist f√ºr wichtige Nachrichten.</p>
            {% endif %}
            <form method="POST">
                <div class="row">
                    <div class="col">
                        <input type="text" name="override_text" placeholder="Freitext eingeben...">
                        <button class="btn btn-warning" style="width:100%; margin-top:5px;" type="submit" name="override_action" value="message">‚ö° Nachricht Senden</button>
                    </div>
                    <div class="col">
                        <div style="display:flex; gap:10px; height: 100%; align-items: flex-end;">
                            <button class="btn btn-upload" style="flex:1;" type="submit" name="override_action" value="happyhour">üçπ Happy Hour</button>
                            <button class="btn btn-warning" style="flex:1;" type="submit" name="override_action" value="lastcall">‚ö†Ô∏è Last Call</button>
                        </div>
                    </div>
                </div>
                {% if override.active %}
                <button class="btn" style="background: #28a745; color: white; width: 100%; margin-top: 15px; padding: 15px;" type="submit" name="override_action" value="stop">‚úÖ NORMALBETRIEB WIEDERHERSTELLEN</button>
                {% endif %}
            </form>
        </div>

        <div class="card">
            <h2>üñ•Ô∏è System Status</h2>
            <div class="row">
                <div class="col">
                    <div style="margin-bottom: 15px;"><strong>Temperatur:</strong> <span class="temp-badge">{{ stats.temp }}</span></div>
                    <div><strong>Speicherplatz:</strong><div class="stat-bar-bg"><div class="stat-bar-fill" style="width: {{ stats.disk_percent }}%;"></div></div><small style="color:#888;">{{ stats.disk_used }} GB belegt von {{ stats.disk_total }} GB</small></div>
                </div>
                <div class="col" style="display:flex; gap:10px; justify-content: flex-end; align-items: center;">
                    <form method="POST" style="width:100%;">
                        <button class="btn btn-dark" type="submit" name="system_action" value="reboot" onclick="return confirm('Neustart?');">üîÑ Neustart</button>
                        <button class="btn btn-danger" type="submit" name="system_action" value="shutdown" onclick="return confirm('Ausschalten?');">üõë Aus</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" id="mainForm">

        <div id="media" class="tab-content">
            <div class="row">
                <div class="col card">
                    <h3>‚¨ÜÔ∏è Datei Hochladen</h3>
                    <p style="font-size:0.9em; color:#aaa;">Bilder, Videos oder PDF</p>
                    <input type="file" name="file" accept="image/*,video/mp4,application/pdf">
                    <button class="btn btn-upload" style="margin-top:10px;" type="submit">Hochladen</button>
                </div>
                <div class="col card">
                    <h3>‚úçÔ∏è Text-Tafel erstellen</h3>
                    <textarea name="slide_text" rows="2" placeholder="z.B. Heute Ruhetag..."></textarea>
                    <div class="row" style="margin-top:10px; gap:10px;">
                        <div class="col"><label style="margin:0">BG</label><input type="color" name="slide_bg" value="#000000"></div>
                        <div class="col"><label style="margin:0">Text</label><input type="color" name="slide_fg" value="#ffffff"></div>
                    </div>
                    <button class="btn btn-create" type="submit" name="create_text_slide" value="1">Tafel Erstellen</button>
                </div>
            </div>
            <div class="card">
                <h2>üìÖ Playlist (Drag & Drop)</h2>
                <div id="playlist">
                    {% for file in files %}
                    <div class="playlist-item" data-filename="{{ file.name }}">
                        <div style="cursor: grab; padding:0 15px; font-size:20px; color:#555;">‚ò∞</div>
                        {% if file.name.endswith('.mp4') %}
                            <video class="thumb" src="{{ url_for('static', filename='uploads/' + file.name) }}"></video>
                        {% else %}
                            <img class="thumb" src="{{ url_for('static', filename='uploads/' + file.name) }}">
                        {% endif %}
                        <div class="details">
                            <strong style="color:white; font-size:0.95em;">{{ file.name }}</strong>
                            <div class="time-inputs">
                                ‚è±Ô∏è <input type="text" class="time-input" name="start_{{ file.name }}" value="{{ file.start }}" placeholder="00:00">
                                bis <input type="text" class="time-input" name="end_{{ file.name }}" value="{{ file.end }}" placeholder="23:59">
                            </div>
                        </div>
                        <button class="btn-delete" type="submit" name="delete" value="{{ file.name }}" onclick="return confirm('L√∂schen?');" title="L√∂schen">üóëÔ∏è</button>
                    </div>
                    {% endfor %}
                </div>
                <div style="text-align:center; padding:20px; color:#666; font-style:italic;">Reihenfolge √§ndern wird sofort gespeichert. Zeiten m√ºssen √ºber den Button unten gespeichert werden.</div>
            </div>
        </div>

        <div id="design" class="tab-content">
            <div class="card">
                <h2>üì∫ Layout & Branding</h2>
                <div class="row">
                    <div class="col">
                        <h3>Layout Modus</h3>
                        <select name="layout">
                            <option value="fullscreen" {% if settings.layout == 'fullscreen' %}selected{% endif %}>Vollbild (Standard)</option>
                            <option value="sidebar" {% if settings.layout == 'sidebar' %}selected{% endif %}>Split-Screen (Sidebar)</option>
                        </select>
                        <div style="margin-top:10px;"><label><input type="checkbox" name="sidebar_clock" {% if settings.sidebar_clock %}checked{% endif %}> Uhrzeit in Sidebar anzeigen</label></div>
                    </div>
                    <div class="col">
                        <h3>√úbergangseffekt</h3>
                        <select name="transition">
                            <option value="fade" {% if settings.transition == 'fade' %}selected{% endif %}>Fade (Weich)</option>
                            <option value="slide" {% if settings.transition == 'slide' %}selected{% endif %}>Slide (Schieben)</option>
                            <option value="zoom" {% if settings.transition == 'zoom' %}selected{% endif %}>Zoom (Dynamisch)</option>
                            <option value="flip" {% if settings.transition == 'flip' %}selected{% endif %}>Flip (Klappen)</option>
                            <option value="none" {% if settings.transition == 'none' %}selected{% endif %}>Kein Effekt</option>
                        </select>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col">
                        <h3>Logo Overlay</h3>
                        <label>Datei (PNG):</label><input type="file" name="logo_file" accept="image/*">
                        <label>Position:</label>
                        <select name="logo_position">
                            <option value="top-left" {% if settings.logo_position == 'top-left' %}selected{% endif %}>Oben Links</option>
                            <option value="top-right" {% if settings.logo_position == 'top-right' %}selected{% endif %}>Oben Rechts</option>
                            <option value="bottom-left" {% if settings.logo_position == 'bottom-left' %}selected{% endif %}>Unten Links</option>
                            <option value="bottom-right" {% if settings.logo_position == 'bottom-right' %}selected{% endif %}>Unten Rechts</option>
                        </select>
                        <label><input type="checkbox" name="logo_active" {% if settings.logo_active %}checked{% endif %}> Logo dauerhaft anzeigen</label>
                    </div>
                    <div class="col">
                        <h3>Sidebar Inhalt</h3>
                        <label>Titel:</label><input type="text" name="sidebar_title" value="{{ settings.sidebar_title }}">
                        <label>Text:</label><textarea name="sidebar_text" rows="4">{{ settings.sidebar_text }}</textarea>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üß© Widgets</h2>
                <div class="row">
                    <div class="col">
                        <h3>Lauftext (Ticker)</h3>
                        <label><input type="checkbox" name="ticker_active" {% if settings.ticker_active %}checked{% endif %}> Aktivieren</label>
                        <input type="text" name="ticker_text" value="{{ settings.ticker_text }}" placeholder="Nachricht...">
                        <div class="row" style="margin-top:5px;">
                            <div class="col"><label>Hintergrund</label><input type="color" name="ticker_bg" value="{{ settings.ticker_bg }}"></div>
                            <div class="col"><label>Schrift</label><input type="color" name="ticker_color" value="{{ settings.ticker_color }}"></div>
                        </div>
                    </div>
                    <div class="col">
                        <h3>QR & Wetter</h3>
                        <label><input type="checkbox" name="qr_active" {% if settings.qr_active %}checked{% endif %}> QR-Code:</label>
                        <input type="text" name="qr_text" value="{{ settings.qr_text }}">
                        <hr style="margin:15px 0;">
                        <label><input type="checkbox" name="weather_active" {% if settings.weather_active %}checked{% endif %}> Wetter (Stadt):</label>
                        <input type="text" name="weather_city" value="{{ settings.weather_city }}">
                    </div>
                </div>
                <hr>
                
                <h3>‚è≥ Event Countdown</h3>
                <div class="row">
                    <div class="col">
                        <label><input type="checkbox" name="countdown_active" {% if settings.countdown_active %}checked{% endif %}> Aktivieren</label>
                        <label>Ziel-Zeitpunkt:</label>
                        <input type="datetime-local" name="countdown_target" value="{{ settings.countdown_target }}">
                    </div>
                    <div class="col">
                        <label>Beschriftung:</label>
                        <input type="text" name="countdown_label" value="{{ settings.countdown_label }}">
                        <p style="color:#777; font-size:0.9em; margin-top:5px;">Wird unten rechts eingeblendet.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="system" class="tab-content">
            <div class="card">
                <h2>‚öôÔ∏è Grundeinstellungen</h2>
                <div class="row">
                    <div class="col"><label>Bildwechsel Dauer (Sekunden):</label><input type="number" name="duration" value="{{ settings.duration }}" min="1"></div>
                    <div class="col">
                        <label>Bildschirm Rotation:</label>
                        <select name="rotation">
                            <option value="0" {% if settings.rotation == 0 %}selected{% endif %}>0¬∞ (Standard)</option>
                            <option value="90" {% if settings.rotation == 90 %}selected{% endif %}>90¬∞</option>
                            <option value="180" {% if settings.rotation == 180 %}selected{% endif %}>180¬∞</option>
                            <option value="270" {% if settings.rotation == 270 %}selected{% endif %}>270¬∞</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>üíæ Backup & Restore</h2>
                <div class="row">
                    <div class="col">
                        <h3>Sichern</h3>
                        <a href="{{ url_for('download_backup') }}" class="btn btn-warning" style="text-decoration:none; display:block;">Backup Herunterladen (.zip)</a>
                    </div>
                    <div class="col">
                        <h3>Wiederherstellen</h3>
                        <input type="file" name="restore_file" accept=".zip">
                        <button class="btn btn-danger" style="margin-top:10px; width:100%;" type="submit" name="system_action" value="restore" onclick="return confirm('ACHTUNG: Alles wird √ºberschrieben!');">Backup Einspielen</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="sticky-save" class="sticky-save"><button class="btn btn-save" style="width: 300px; margin:0;" type="submit">üíæ Alles Speichern</button></div>
    </form>

    <script>
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.textContent.toLowerCase().includes(tabName.substring(0,3)));
            if(btn) btn.classList.add('active');
            const saveBar = document.getElementById('sticky-save');
            if(tabName === 'dashboard') saveBar.style.display = 'none'; else saveBar.style.display = 'block';
            localStorage.setItem('activeTab', tabName);
        }
        document.addEventListener('DOMContentLoaded', () => { const lastTab = localStorage.getItem('activeTab') || 'dashboard'; openTab(lastTab); });
        var el = document.getElementById('playlist');
        var sortable = Sortable.create(el, {
            animation: 150, handle: '.playlist-item',
            onEnd: function (evt) {
                var newOrder = []; document.querySelectorAll('.playlist-item').forEach(function(item) { newOrder.push(item.getAttribute('data-filename')); });
                var formData = new FormData(); formData.append('sort_order', JSON.stringify(newOrder)); fetch('/admin', { method: 'POST', body: formData });
            }
        });
    </script>
</body>
</html>